[Unit]
Description=[pipower] Monitor SHUTDOWN signal

[Service]
Type=simple
Environment=PIN_SHUTDOWN=17
EnvironmentFile=-/etc/default/pipower
ExecStartPre=/usr/bin/gpio -g mode $PIN_SHUTDOWN input
ExecStartPre=/usr/bin/gpio -g mode $PIN_SHUTDOWN down
ExecStart=/usr/bin/gpio -g wfi $PIN_SHUTDOWN rising
ExecStopPost=/bin/sh -c "test -f /run/pipower/inhibit || /bin/systemctl poweroff"

[Install]
WantedBy=multi-user.target
