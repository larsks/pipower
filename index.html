<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>PiPower: PiPower</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PiPower
   &#160;<span id="projectnumber">ac0ff3c (Mon Feb 11 21:44:30 2019 -0500)</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PiPower </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Turn an Adafruit <a href="https://www.adafruit.com/product/2465">PowerBoost 1000c</a> into a UPS with the help of an <a href="https://www.microchip.com/wwwproducts/en/ATtiny85">ATtiny85</a> microcontroller.</p>
<h2>Caveats</h2>
<p>The PowerBoost 1000c can only provide about 1.1A, which may not be sufficient to power a Raspberry Pi 3(+). According to the <a href="https://www.raspberrypi.org/documentation/faqs/#pi-power">FAQ</a>, the Pi 3 may draw up to 1.2A under load. The typical current draw is listed as around 500mA, which would be fine.</p>
<h2>Theory of operation</h2>
<p>PiPower is designed to ensure that your Pi will shut down cleanly when it is disconnected from its primary power source.</p>
<p>PiPower runs on an ATtiny85 microcontroller and acts as an intermediary between your Raspberry Pi and an Adafruit PowerBoost 1000c. When the microcontroller (mc) boots, it checks to see if an external power source is available to the PowerBoost. If so, it sets the <code>EN</code> line and the PowerBoost starts to supply power to the Pi.</p>
<p>If no external power is available, the mc enters a low power sleep mode until external power is applied. At this point, it will boot the Pi.</p>
<p>When the Pi boots, it must signal to the mc that it has booted successfully by bringing the <code>BOOT</code> line low. If the mc does not receive this signal within 30 seconds of providing power, it will turn off the power and return to the low power mode.</p>
<p>If external power is lost while the Pi is running, or if you press the power button while the Pi is running, the mc will send the <code>SHUTDOWN</code> signal to the Pi. It will then wait up to 30 seconds for the Pi to shut down. The Pi can signal a clean shutdown by setting the <code>BOOT</code> line high. Once the shutdown is complete (or if 30 seconds pass), the mc will remove power from the Pi and return to low power mode.</p>
<h2>Installing pipower on your attiny85</h2>
<p>Run <code>make</code> to build the executable: </p><pre class="fragment">make
</pre><p>Run <code>make flash</code> to upload the image to your attiny85: </p><pre class="fragment">make flash
</pre><p>The <code>Makefile</code> assumes you are using an Arduino UNO as your ISP. If you're using something else you will need to update the Makefile appropriately.</p>
<h2>Pins</h2>
<ul>
<li><code>PB0</code> - <code>USB</code> line from PowerBoost</li>
<li><code>PB1</code> - power button</li>
<li><code>PB2</code> - <code>ENABLE</code> line to PowerBoost</li>
<li><code>PB3</code> - <code>BOOT</code> signal from Raspberry Pi</li>
<li><code>PB4</code> - <code>SHUTDOWN</code> signal to Raspberry Pi</li>
</ul>
<h2>Installing on your Raspberry Pi</h2>
<p>The <code>pipowerd</code> directory contains the components that need to be installed on your Raspberry Pi. Clone the repository onto your Pi, cd into the <code>pipowerd</code> directory, and run: </p><pre class="fragment">make
</pre><p>This will build the <code>pipowerd</code> executable, which is a daemon that will monitor a GPIO pin for the shutdown signal from <code>pipower</code>. When it receives the shutdown signal it runs <code>systemctl poweroff</code>.</p>
<p>To install <code>pipowerd</code> and the associated <code>systemd</code> units, run: </p><pre class="fragment">make install
</pre><p>To enable the new services, run: </p><pre class="fragment">make activate
</pre><h3>systemd units</h3>
<p>The <code>Makefile</code> will install the following systemd units:</p>
<ul>
<li><p class="startli"><code>pipower-boot.service</code></p>
<p class="startli">Asserts the <code>BOOT</code> signal on <code>PIN_BOOT</code> (default <code>GPIO4</code>) when the Pi boots and de-asserts it on shutdown.</p>
</li>
<li><p class="startli"><code>pipowerd.service</code></p>
<p class="startli">Launches the <code>pipowerd</code> daemon to monitor for shutdown signals on <code>PIN_SHUTDOWN</code>.</p>
</li>
</ul>
<p>You can configure these services by creating the file <code>/etc/default/pipower</code>, which may set one or more of the following variables:</p>
<ul>
<li><code>PIN_POWER</code> - BCM GPIO on which to assert the <code>BOOT</code> signal.</li>
<li><code>PIN_SHUTDOWN</code> - BCM GPIO on which to watch for the <code>SHUTDOWN</code> signal</li>
</ul>
<h2>See also</h2>
<ul>
<li>Doxygen documentation for this project is online at <a href="http://oddbit.com/pipower">http://oddbit.com/pipower</a></li>
<li><a href="https://learn.adafruit.com/adafruit-powerboost-1000c-load-share-usb-charge-boost/downloads">PowerBoost 1000c data sheets/pinouts/etc</a></li>
<li><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-2586-AVR-8-bit-Microcontroller-ATtiny25-ATtiny45-ATtiny85_Datasheet.pdf">ATtiny85 data sheet</a></li>
</ul>
<h2>License</h2>
<p>PiPower, a UPS for your Raspberry Pi Copyright (C) 2019 Lars Kellogg-Stedman <a href="#" onclick="location.href='mai'+'lto:'+'lar'+'s@'+'odd'+'bi'+'t.c'+'om'; return false;">lars@<span style="display: none;">.nosp@m.</span>oddb<span style="display: none;">.nosp@m.</span>it.co<span style="display: none;">.nosp@m.</span>m</a></p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
